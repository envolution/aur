name: Arch Chroot Test

on:
  workflow_dispatch:

jobs:
  arch-chroot:
    runs-on: ubuntu-latest
    steps:
      - name: Download Arch bootstrap
        run: |
          curl -LO https://iad.mirror.rackspace.com/archlinux/iso/latest/archlinux-bootstrap-x86_64.tar.zst
          tar --zstd -xvf archlinux-bootstrap-x86_64.tar.zst --ignore-failed-read --warning=no-timestamp || true
          sudo mv root.x86_64 /opt/arch-root

      - name: Bind mounts
        run: |
          sudo mount --bind /dev /opt/arch-root/dev
          sudo mount --bind /proc /opt/arch-root/proc
          sudo mount --bind /sys /opt/arch-root/sys

      - name: Test pacman
        run: |
          sudo chroot /opt/arch-root pacman -Sy --noconfirm
          sudo chroot /opt/arch-root pacman -Q pacman

      - name: Cleanup mounts
        if: always()
        run: |
          sudo umount /opt/arch-root/dev || true
          sudo umount /opt/arch-root/proc || true
          sudo umount /opt/arch-root/sys || true
